<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auction Marketplace</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 1rem 0; }
        .header .container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .nav-links { display: flex; gap: 15px; }
        .nav-links a { color: white; text-decoration: none; padding: 5px 10px; }
        .search-section { background: white; padding: 2rem 0; }
        .search-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input, .category-select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .search-input { flex: 1; }
        .price-filter { padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 120px; }
        .search-btn { padding: 10px 20px; background: #11998e; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .auctions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .auction-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: 520px; display: flex; flex-direction: column; }
        .auction-image { height: 150px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999; position: relative; flex-shrink: 0; }
        .auction-badge { position: absolute; top: 10px; right: 10px; background: #11998e; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.75rem; }
        .auction-badge.ended { background: #666; }
        .owner-controls { position: absolute; top: 10px; left: 10px; }
        .delete-btn { background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s; }
        .delete-btn:hover { background: #c82333; }
        .auction-content { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .auction-title { font-weight: bold; margin-bottom: 8px; font-size: 1rem; line-height: 1.2; height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .auction-price-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .auction-price { color: #11998e; font-weight: bold; font-size: 1.1rem; }
        .auction-time { font-size: 0.8rem; color: #666; }
        .auction-stats { font-size: 0.8rem; color: #666; margin-bottom: 15px; }
        .top-bidders { }
        .top-bidders span { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bidders-list { }
        .bidders-header { font-weight: bold; margin-bottom: 6px; color: #11998e; font-size: 0.8rem; }
        .bidder-item { padding: 4px 0; margin-bottom: 3px; font-size: 0.7rem; color: #555; border-left: 3px solid #11998e; padding-left: 8px; }
        .bidder-item:last-child { margin-bottom: 0; }
        .bidder-item.winner { color: #28a745; border-left-color: #28a745; font-weight: bold; }
        .auction-description { color: #666; margin-bottom: 10px; font-size: 0.85rem; line-height: 1.3; height: 3.9em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; flex: 1; }
        .auction-details-btn { background: none; border: none; color: #11998e; font-size: 0.8rem; cursor: pointer; text-align: left; padding: 0; margin-bottom: 10px; text-decoration: underline; }
        .auction-details-btn:hover { color: #0d7a6f; }
        .bidding-section { border-top: 1px solid #eee; padding-top: 10px; margin-top: auto; }
        .bid-form { display: flex; gap: 10px; margin-bottom: 10px; }
        .bid-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        .bid-btn { padding: 8px 15px; background: #11998e; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .buy-now-btn { width: 100%; padding: 10px; background: #ff6b35; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 5px; margin-bottom: 3px; }
        .auction-meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: #999; margin-top: 8px; padding-top: 5px; }
        .loading, .no-results { text-align: center; padding: 40px; color: #666; }
        .hidden { display: none; }
        
        /* Toast Notification System */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 10px; padding: 15px 20px; max-width: 400px; border-left: 4px solid; transform: translateX(100%); opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-color: #28a745; }
        .toast.error { border-color: #dc3545; }
        .toast.warning { border-color: #ffc107; }
        .toast.info { border-color: #17a2b8; }
        .toast-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .toast-title { font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .toast-title i { font-size: 1.1rem; }
        .toast-close { background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.6; }
        .toast-close:hover { opacity: 1; }
        .toast-body { color: #666; }
        .toast.success .toast-title { color: #28a745; }
        .toast.error .toast-title { color: #dc3545; }
        .toast.warning .toast-title { color: #ff8c00; }
        .toast.info .toast-title { color: #17a2b8; }
        
        /* Auction Details Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal { background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { padding: 20px 20px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .modal-title { font-size: 1.3rem; font-weight: bold; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; }
        .modal-body { padding: 20px; }
        .modal-image { width: 100%; height: 200px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .modal-price { font-size: 1.5rem; color: #11998e; font-weight: bold; margin-bottom: 10px; }
        .modal-description { color: #333; line-height: 1.5; margin-bottom: 15px; }
        .modal-meta { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .modal-meta-item { margin-bottom: 8px; }
        .modal-meta-item:last-child { margin-bottom: 0; }
        .modal-meta-label { font-weight: bold; color: #555; }
        .modal-bidders-list { margin-top: 8px; }
        .modal-bidder-item { background: #fff; padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; font-size: 0.95rem; color: #333; border: 1px solid #e9ecef; border-left: 3px solid #11998e; }
        .modal-bidder-item.winner { background: #e8f5e8; border-left-color: #28a745; font-weight: bold; }
        .modal-bidders-container { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #e9ecef; }
        .modal-bidders-title { font-size: 1.1rem; font-weight: bold; color: #11998e; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .modal-actions { border-top: 1px solid #eee; padding: 20px; }
        
        @media (max-width: 768px) { 
            .search-form { flex-direction: column; } 
            .auctions-grid { grid-template-columns: 1fr; }
            .toast-container { top: 10px; right: 10px; left: 10px; }
            .toast { max-width: none; }
        }
        
        /* Pagination Styles */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 5px; margin: 20px 0; }
        .pagination-btn { background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 4px; cursor: pointer; color: #333; text-decoration: none; transition: all 0.3s; }
        .pagination-btn:hover { background: #f8f9fa; border-color: #11998e; }
        .pagination-btn.active { background: #11998e; color: white; border-color: #11998e; }
        .pagination-dots { padding: 8px 4px; color: #999; }
        .pagination-info { text-align: center; margin: 10px 0; font-size: 0.9rem; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="logo"><i class="fas fa-store"></i> Marketplace</div>
            <div class="nav-links">
                <a href="#" id="loginLink">–í—Ö–æ–¥</a>
                <a href="create_auction.html" id="createAuctionLink" class="hidden"><i class="fas fa-plus"></i> –°—ä–∑–¥–∞–π —Ç—ä—Ä–≥</a>
                <a href="#" id="userMenu" class="hidden" onclick="showMyProfile(); return false;"><i class="fas fa-user"></i> <span id="userName"></span></a>
                <a href="#" id="logoutLink" class="hidden">–ò–∑—Ö–æ–¥</a>
            </div>
        </div>
    </div>

    <div class="search-section">
        <div class="container">
            <div class="search-form">
                <input type="text" class="search-input" id="searchInput" placeholder="–¢—ä—Ä—Å–µ–Ω–µ –Ω–∞ —Ç—ä—Ä–≥–æ–≤–µ...">
                <select class="category-select" id="categorySelect">
                    <option value="">–í—Å–∏—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <option value="electronics">–ï–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
                    <option value="fashion">–ú–æ–¥–∞</option>
                    <option value="home">–î–æ–º –∏ –≥—Ä–∞–¥–∏–Ω–∞</option>
                    <option value="sports">–°–ø–æ—Ä—Ç</option>
                    <option value="cars">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</option>
                    <option value="others">–î—Ä—É–≥–∏</option>
                </select>
                <select class="category-select" id="priceSort">
                    <option value="">–°–æ—Ä—Ç–∏—Ä–∞–Ω–µ –ø–æ —Ü–µ–Ω–∞</option>
                    <option value="asc">–¶–µ–Ω–∞: –Ω–∏—Å–∫–∞ –∫—ä–º –≤–∏—Å–æ–∫–∞</option>
                    <option value="desc">–¶–µ–Ω–∞: –≤–∏—Å–æ–∫–∞ –∫—ä–º –Ω–∏—Å–∫–∞</option>
                </select>
                <button class="search-btn" onclick="searchAuctions()"><i class="fas fa-search"></i> –¢—ä—Ä—Å–∏</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="auctionsContainer">
            <div class="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Ç—ä—Ä–≥–æ–≤–µ...</div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        let currentAuctions = [];
        let currentSearch = '';
        let currentCategory = '';
        let currentPriceSort = '';
        let currentUser = null;
        let currentPage = 1;
        const auctionsPerPage = 6;
        let totalAuctions = 0;

        // Toast Notification System
        function showToast(title, message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle', 
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            toast.innerHTML = `
                <div class="toast-header">
                    <div class="toast-title">
                        <i class="${icons[type]}"></i>
                        ${title}
                    </div>
                    <button class="toast-close" onclick="closeToast(this)">&times;</button>
                </div>
                <div class="toast-body">${message}</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto-remove toast
            setTimeout(() => {
                if (toast.parentNode) {
                    closeToast(toast.querySelector('.toast-close'));
                }
            }, duration);
        }
        
        function closeToast(closeButton) {
            const toast = closeButton.closest('.toast');
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }

        window.addEventListener('load', () => {
            checkUserSession();
            loadAuctions();
            startCountdownTimer();
            startAuctionPolling(); // Start real-time polling for auction updates
            
            // Check session every 30 seconds to detect user changes
            setInterval(checkUserSession, 30000);
        });

        // Also check session when page becomes visible again
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                checkUserSession();
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchAuctions();
        });

        async function checkUserSession() {
            try {
                const response = await fetch('/backend/check_session.php');
                const data = await response.json();
                
                // Always update currentUser, even if logged out
                const previousUser = currentUser;
                currentUser = data.logged_in ? data.user : null;
                
                if (data.logged_in) {
                    document.getElementById('loginLink').style.display = 'none';
                    document.getElementById('createAuctionLink').classList.remove('hidden');
                    document.getElementById('userMenu').classList.remove('hidden');
                    document.getElementById('logoutLink').classList.remove('hidden');
                    document.getElementById('userName').textContent = data.user.username;
                } else {
                    document.getElementById('loginLink').style.display = 'block';
                    document.getElementById('createAuctionLink').classList.add('hidden');
                    document.getElementById('userMenu').classList.add('hidden');
                    document.getElementById('logoutLink').classList.add('hidden');
                }
                
                // If user changed, re-render auctions to update ownership
                if (previousUser?.id !== currentUser?.id) {
                    renderAuctions();
                }
            } catch (error) { 
                console.log('No active session');
                currentUser = null;
            }
        }

        async function loadAuctions(page = 1) {
            try {
                const offset = (page - 1) * auctionsPerPage;
                let url = `/backend/auctions.php?search=${encodeURIComponent(currentSearch)}&category=${encodeURIComponent(currentCategory)}&status=all&limit=${auctionsPerPage}&offset=${offset}`;
                
                if (currentPriceSort) {
                    url += `&price_sort=${encodeURIComponent(currentPriceSort)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    currentAuctions = data.auctions;
                    totalAuctions = data.total;
                    currentPage = page;
                    renderAuctions();
                    renderPagination();
                } else {
                    document.getElementById('auctionsContainer').innerHTML = `
                        <div class="no-results"><h3>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ</h3><p>${data.message}</p></div>`;
                }
            } catch (error) {
                document.getElementById('auctionsContainer').innerHTML = `
                    <div class="no-results"><h3>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ</h3></div>`;
            }
        }

        function renderAuctions() {
            const container = document.getElementById('auctionsContainer');
            
            if (currentAuctions.length === 0) {
                container.innerHTML = '<div class="no-results"><h3>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ç—ä—Ä–≥–æ–≤–µ</h3></div>';
                return;
            }

            const auctionsHTML = currentAuctions.map(auction => {
                const isActive = auction.actual_status === 'active';
                const timeLeft = isActive ? formatTimeRemaining(auction.time_remaining) : '–ü—Ä–∏–∫–ª—é—á–∏–ª';
                const currentPrice = auction.current_price || auction.starting_price;
                const truncatedDescription = truncateText(auction.description || '–ù—è–º–∞ –æ–ø–∏—Å–∞–Ω–∏–µ', 100);
                const isOwner = currentUser && currentUser.id == auction.user_id;
                const hasBids = auction.total_bids > 0;
                
                return `
                    <div class="auction-card" data-auction-id="${auction.id}">
                        <div class="auction-image">
                            ${auction.image_url ? 
                                `<img src="${auction.image_url}" alt="${auction.title}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                '<i class="fas fa-image"></i>'
                            }
                            <div class="auction-badge ${isActive ? '' : 'ended'}">${isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ü—Ä–∏–∫–ª—é—á–∏–ª'}</div>
                            ${isOwner && !hasBids && isActive ? '<div class="owner-controls"><button class="delete-btn" onclick="deleteAuction(' + auction.id + ')" title="–ò–∑—Ç—Ä–∏–π —Ç—ä—Ä–≥"><i class="fas fa-trash"></i></button></div>' : ''}
                        </div>
                        <div class="auction-content">
                            <div class="auction-title">${auction.title}</div>
                            <div class="auction-price-line">
                                <div class="auction-price">${currentPrice} –ª–≤.</div>
                                <div class="auction-time"><i class="fas fa-clock"></i> <span class="auction-time-remaining" data-auction-id="${auction.id}">${timeLeft}</span></div>
                            </div>
                            <div class="auction-stats">
                                <div class="top-bidders">
                                    ${auction.top_bidders && auction.top_bidders.length > 0 ? 
                                        `<div class="bidders-list">
                                            <div class="bidders-header">${isActive ? '–¢–µ–∫—É—â –ø–æ–±–µ–¥–∏—Ç–µ–ª:' : '–ö—É–ø–µ–Ω–æ –æ—Ç:'}</div>
                                            <div class="bidder-item winner">üèÜ ${auction.top_bidders[0].username}: ${auction.top_bidders[0].bid_amount} –ª–≤.</div>
                                        </div>` :
                                        `<span><i class="fas fa-gavel"></i> –ù—è–º–∞ –Ω–∞–¥–¥–∞–≤–∞–Ω–∏—è</span>`
                                    }
                                </div>
                            </div>
                            <div class="auction-description">${truncatedDescription}</div>
                            <button class="auction-details-btn" onclick="showAuctionDetails(${auction.id})">–í–∏–∂ –¥–µ—Ç–∞–π–ª–∏</button>
                            
                            ${isActive ? `
                                <div class="bidding-section">
                                    <div class="bid-form">
                                        <input type="number" class="bid-input" placeholder="–ù–∞–¥–¥–∞–π—Ç–µ..." min="${parseFloat(currentPrice) + 1}" max="99999999.99" step="0.01">
                                        <button class="bid-btn" onclick="placeBid(${auction.id})">–ù–∞–¥–¥–∞–π</button>
                                    </div>
                                    ${auction.buy_now_price ? `<button class="buy-now-btn" onclick="buyNow(${auction.id}, ${auction.buy_now_price})">–ö—É–ø–∏ —Å–µ–≥–∞ –∑–∞ ${auction.buy_now_price} –ª–≤.</button>` : ''}
                                </div>
                            ` : ''}
                            
                            <div id="recentBids${auction.id}" style="margin: 5px 0;"></div>
                            
                            <div class="auction-meta">
                                <span><i class="fas fa-map-marker-alt"></i> ${auction.location || '–ù–µ –µ –ø–æ—Å–æ—á–µ–Ω–æ'}</span>
                                <span>${formatDate(auction.created_at)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="auctions-grid">${auctionsHTML}</div>
                <div id="paginationContainer"></div>
            `;
        }

        function renderPagination() {
            const container = document.getElementById('paginationContainer');
            if (!container) return;
            
            const totalPages = Math.ceil(totalAuctions / auctionsPerPage);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let paginationHTML = '<div class="pagination">';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<button class="pagination-btn" onclick="loadAuctions(${currentPage - 1})">‚Üê –ü—Ä–µ–¥–∏—à–Ω–∞</button>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button class="pagination-btn" onclick="loadAuctions(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += '<span class="pagination-dots">...</span>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                paginationHTML += `<button class="pagination-btn ${activeClass}" onclick="loadAuctions(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += '<span class="pagination-dots">...</span>';
                }
                paginationHTML += `<button class="pagination-btn" onclick="loadAuctions(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<button class="pagination-btn" onclick="loadAuctions(${currentPage + 1})">–°–ª–µ–¥–≤–∞—â–∞ ‚Üí</button>`;
            }
            
            paginationHTML += '</div>';
            paginationHTML += `<div class="pagination-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –æ—Ç ${totalPages} ‚Ä¢ –û–±—â–æ ${totalAuctions} —Ç—ä—Ä–≥–∞</div>`;
            
            container.innerHTML = paginationHTML;
        }

        function updateAuctionAfterBid(auctionId, newPrice, totalBids, topBidders) {
            // Update the auction in the currentAuctions array
            const auctionIndex = currentAuctions.findIndex(auction => auction.id == auctionId);
            if (auctionIndex !== -1) {
                currentAuctions[auctionIndex].current_price = newPrice;
                currentAuctions[auctionIndex].total_bids = totalBids;
                if (topBidders) {
                    currentAuctions[auctionIndex].top_bidders = topBidders;
                }
                
                // Update the DOM elements immediately
                const auctionCard = document.querySelector(`[data-auction-id="${auctionId}"]`);
                if (auctionCard) {
                    // Update the price
                    const priceElement = auctionCard.querySelector('.auction-price');
                    if (priceElement) {
                        priceElement.textContent = `${newPrice} –ª–≤.`;
                    }
                    
                    // Update bid input minimum value
                    const bidInput = auctionCard.querySelector('.bid-input');
                    if (bidInput) {
                        bidInput.min = parseFloat(newPrice) + 1;
                        bidInput.placeholder = "–ù–∞–¥–¥–∞–π—Ç–µ...";
                    }
                    
                    // Update top bidders display if topBidders data is provided
                    if (topBidders) {
                        const topBiddersElement = auctionCard.querySelector('.top-bidders');
                        if (topBiddersElement) {
                            const biddersHTML = topBidders.length > 0 ? 
                                `<div class="bidders-list">
                                    <div class="bidders-header"><i class="fas fa-crown"></i> –¢–µ–∫—É—â –≤–æ–¥–µ—â:</div>
                                    <div class="bidder-item winner">üèÜ ${topBidders[0].username}: ${topBidders[0].bid_amount} –ª–≤.</div>
                                </div>` :
                                `<span><i class="fas fa-gavel"></i> –ù—è–º–∞ –Ω–∞–¥–¥–∞–≤–∞–Ω–∏—è</span>`;
                            
                            topBiddersElement.innerHTML = biddersHTML;
                        }
                    }
                }
            }
        }

        function searchAuctions() {
            currentSearch = document.getElementById('searchInput').value.trim();
            currentCategory = document.getElementById('categorySelect').value;
            currentPriceSort = document.getElementById('priceSort').value;
            currentPage = 1; // Reset to first page on search
            loadAuctions(1);
        }

        async function placeBid(auctionId) {
            // Check if user is logged in
            if (!currentUser) {
                showToast('–ù–µ–æ–±—Ö–æ–¥–∏–º –≤—Ö–æ–¥', '–¢—Ä—è–±–≤–∞ –¥–∞ —Å—Ç–µ –≤–ª–µ–∑–ª–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏, –∑–∞ –¥–∞ –Ω–∞–¥–¥–∞–≤–∞—Ç–µ!', 'warning');
                return;
            }
            
            const bidInput = document.querySelector(`[data-auction-id="${auctionId}"] .bid-input`);
            const bidAmount = parseFloat(bidInput.value);
            
            if (!bidAmount) { 
                showToast('–ù–µ–≤–∞–ª–∏–¥–Ω–∞ —Å—É–º–∞', '–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–∞ —Å—É–º–∞ –∑–∞ –Ω–∞–¥–¥–∞–≤–∞–Ω–µ!', 'warning');
                return; 
            }
            
            // Validate maximum bid amount
            if (bidAmount > 99999999.99) {
                showToast('–¢–≤—ä—Ä–¥–µ –≥–æ–ª—è–º–∞ —Å—É–º–∞', '–ú–∞–∫—Å–∏–º–∞–ª–Ω–∞—Ç–∞ –≤—ä–∑–º–æ–∂–Ω–∞ –Ω–∞–¥–¥–∞–≤–∫–∞ –µ 99,999,999.99 –ª–≤.!', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/backend/auctions.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auction_id: auctionId, bid_amount: bidAmount })
                });
                
                const data = await response.json();
                if (data.success) {
                    bidInput.value = '';
                    
                    // Update the auction data in memory and UI immediately
                    updateAuctionAfterBid(auctionId, data.new_price, data.total_bids, data.top_bidders);
                    
                } else {
                    showToast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –Ω–∞–¥–¥–∞–≤–∞–Ω–µ', data.message || '–í—ä–∑–Ω–∏–∫–Ω–∞ –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ –Ω–∞–¥–¥–∞–≤–∞–Ω–µ—Ç–æ.', 'error');
                }
            } catch (error) { 
                showToast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ', '–ù–µ –º–æ–∂–∞—Ö–º–µ –¥–∞ —Å–µ —Å–≤—ä—Ä–∂–µ–º —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.', 'error');
            }
        }

        async function buyNow(auctionId, price) {
            // Check if user is logged in
            if (!currentUser) {
                showToast('–ù–µ–æ–±—Ö–æ–¥–∏–º –≤—Ö–æ–¥', '–¢—Ä—è–±–≤–∞ –¥–∞ —Å—Ç–µ –≤–ª–µ–∑–ª–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏, –∑–∞ –¥–∞ –∫—É–ø—É–≤–∞—Ç–µ!', 'warning');
                return;
            }
            
            // Confirm the purchase
            if (!confirm(`–ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –∫—É–ø–∏—Ç–µ —Ç–æ–∑–∏ –∞—Ä—Ç–∏–∫—É–ª —Å–µ–≥–∞ –∑–∞ ${price} –ª–≤.? –¢–æ–≤–∞ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.`)) {
                return;
            }
            
            try {
                const response = await fetch('/backend/auctions.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'buy_now', 
                        auction_id: auctionId 
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('–£—Å–ø–µ—à–Ω–∞ –ø–æ–∫—É–ø–∫–∞!', `–£—Å–ø–µ—à–Ω–æ –∑–∞–∫—É–ø–∏—Ö—Ç–µ –∞—Ä—Ç–∏–∫—É–ª–∞ –∑–∞ ${data.final_price} –ª–≤.!`, 'success');
                    
                    // Remove the auction from the display or mark as ended
                    const auctionCard = document.querySelector(`[data-auction-id="${auctionId}"]`);
                    if (auctionCard) {
                        auctionCard.querySelector('.auction-badge').textContent = '–ü—Ä–∏–∫–ª—é—á–∏–ª';
                        auctionCard.querySelector('.auction-badge').classList.add('ended');
                        
                        // Remove bidding section
                        const biddingSection = auctionCard.querySelector('.bidding-section');
                        if (biddingSection) {
                            biddingSection.remove();
                        }
                        
                        // Update price to final buy now price
                        const priceElement = auctionCard.querySelector('.auction-price');
                        if (priceElement) {
                            priceElement.textContent = `${data.final_price} –ª–≤.`;
                        }
                        
                        // Update winner display
                        const topBiddersElement = auctionCard.querySelector('.top-bidders');
                        if (topBiddersElement && data.winner) {
                            topBiddersElement.innerHTML = `
                                <div class="bidders-list">
                                    <div class="bidders-header">–ö—É–ø–µ–Ω–æ –æ—Ç:</div>
                                    <div class="bidder-item winner">üèÜ ${data.winner.username}: ${data.winner.bid_amount} –ª–≤.</div>
                                </div>
                            `;
                        }
                        
                        // Update time remaining
                        const timeElement = auctionCard.querySelector('.auction-time-remaining');
                        if (timeElement) {
                            timeElement.textContent = '–ü—Ä–∏–∫–ª—é—á–∏–ª';
                        }
                    }
                    
                    // Close modal if open
                    const modal = document.getElementById('auctionModal');
                    if (modal && modal.style.display !== 'none') {
                        closeModal();
                    }
                    
                } else {
                    showToast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–∞', data.message || '–í—ä–∑–Ω–∏–∫–Ω–∞ –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ –ø–æ–∫—É–ø–∫–∞—Ç–∞.', 'error');
                }
            } catch (error) {
                showToast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ', '–ù–µ –º–æ–∂–∞—Ö–º–µ –¥–∞ —Å–µ —Å–≤—ä—Ä–∂–µ–º —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.', 'error');
            }
        }

        function formatTimeRemaining(seconds) {
            if (seconds <= 0) return '–ü—Ä–∏–∫–ª—é—á–∏–ª';
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (days > 0) return `${days}–¥ ${hours}—á ${mins}–º ${secs}—Å`;
            if (hours > 0) return `${hours}—á ${mins}–º ${secs}—Å`;
            if (mins > 0) return `${mins}–º ${secs}—Å`;
            return `${secs}—Å`;
        }

        function startCountdownTimer() {
            setInterval(() => {
                const timeElements = document.querySelectorAll('.auction-time-remaining, .modal-time-remaining');
                let auctionsEnded = false;
                const processedAuctions = new Set();
                
                // First, update the auction time_remaining for each unique auction
                currentAuctions.forEach(auction => {
                    if (auction.actual_status === 'active' && auction.time_remaining > 0) {
                        auction.time_remaining -= 1;
                        
                        if (auction.time_remaining <= 0) {
                            auction.actual_status = 'ended';
                            auctionsEnded = true;
                        }
                    }
                });
                
                // Then, update all timer elements to display the current time
                timeElements.forEach(element => {
                    const auctionId = element.getAttribute('data-auction-id');
                    const auction = currentAuctions.find(a => a.id == auctionId);
                    if (auction) {
                        if (auction.actual_status === 'ended') {
                            element.textContent = '–ü—Ä–∏–∫–ª—é—á–∏–ª';
                        } else {
                            element.textContent = formatTimeRemaining(auction.time_remaining);
                        }
                        
                        // Update the auction badge if time has expired (only for main cards, not modal)
                        if (auction.time_remaining <= 0 && element.classList.contains('auction-time-remaining')) {
                            const card = document.querySelector(`[data-auction-id="${auctionId}"]`);
                            if (card) {
                                const badge = card.querySelector('.auction-badge');
                                if (badge) {
                                    badge.textContent = '–ü—Ä–∏–∫–ª—é—á–∏–ª';
                                    badge.classList.add('ended');
                                }
                                // Hide bidding section when auction ends
                                const biddingSection = card.querySelector('.bidding-section');
                                if (biddingSection) {
                                    biddingSection.style.display = 'none';
                                }
                                // Remove delete button when auction ends
                                const deleteBtn = card.querySelector('.delete-btn');
                                if (deleteBtn) {
                                    deleteBtn.style.display = 'none';
                                }
                            }
                        }
                    }
                });
                
                // If any auctions ended, process them on the server
                if (auctionsEnded) {
                    processEndedAuctions();
                }
            }, 1000);
        }

        let lastEndedAuctionsProcessed = 0;
        async function processEndedAuctions() {
            // Prevent processing too frequently
            const now = Date.now();
            if (now - lastEndedAuctionsProcessed < 5000) {
                return;
            }
            lastEndedAuctionsProcessed = now;
            
            try {
                const response = await fetch('/backend/end_auctions.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.success && data.processed > 0) {
                    // Reload auctions to get updated status from server with a delay
                    setTimeout(() => {
                        loadAuctions();
                    }, 3000);
                }
            } catch (error) {
                console.error('Error processing ended auctions:', error);
            }
        }

        function startAuctionPolling() {
            // Poll for auction updates every 5 seconds
            setInterval(async () => {
                await checkForAuctionUpdates();
            }, 5000);
        }

        async function checkForAuctionUpdates() {
            // Only update if we're on the first page to avoid pagination conflicts
            if (currentPage !== 1) return;
            
            try {
                let url = `/backend/auctions.php?search=${encodeURIComponent(currentSearch)}&category=${encodeURIComponent(currentCategory)}&status=all&limit=${auctionsPerPage}&offset=0`;
                
                if (currentPriceSort) {
                    url += `&price_sort=${encodeURIComponent(currentPriceSort)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.auctions) {
                    const newAuctions = data.auctions;
                    let hasUpdates = false;
                    let hasNewAuctions = false;
                    
                    // Check for new auctions
                    newAuctions.forEach(newAuction => {
                        const existingAuction = currentAuctions.find(a => a.id === newAuction.id);
                        if (!existingAuction) {
                            // This is a new auction, add it to the list
                            currentAuctions.unshift(newAuction); // Add to beginning
                            hasUpdates = true;
                            hasNewAuctions = true;
                        }
                    });
                    
                    // Check for deleted auctions
                    const currentAuctionIds = newAuctions.map(a => a.id);
                    const deletedAuctions = currentAuctions.filter(auction => !currentAuctionIds.includes(auction.id));
                    if (deletedAuctions.length > 0) {
                        currentAuctions = currentAuctions.filter(auction => currentAuctionIds.includes(auction.id));
                        hasUpdates = true;
                    }
                    
                    // Check each existing auction for updates (price, bids, status, etc.)
                    newAuctions.forEach(newAuction => {
                        const existingAuction = currentAuctions.find(a => a.id === newAuction.id);
                        if (existingAuction) {
                            // Check if price, bidder, or status has changed
                            if (existingAuction.current_price !== newAuction.current_price ||
                                existingAuction.total_bids !== newAuction.total_bids ||
                                existingAuction.actual_status !== newAuction.actual_status ||
                                existingAuction.last_updated !== newAuction.last_updated) {
                                
                                // Update the auction data
                                const auctionIndex = currentAuctions.findIndex(a => a.id === newAuction.id);
                                currentAuctions[auctionIndex] = newAuction;
                                
                                // If status changed to ended, force a full re-render to update UI properly
                                if (existingAuction.actual_status !== newAuction.actual_status && newAuction.actual_status === 'ended') {
                                    hasUpdates = true;
                                } else {
                                    // Update the UI for this specific auction
                                    updateAuctionUI(newAuction);
                                }
                            }
                        }
                    });
                    
                    // If there were new auctions, deletions, or status changes, re-render the entire grid
                    if (hasNewAuctions || deletedAuctions.length > 0 || hasUpdates) {
                        renderAuctions();
                    }
                }
            } catch (error) {
                console.error('Error checking for auction updates:', error);
            }
        }

        function updateAuctionUI(auction) {
            const auctionCard = document.querySelector(`[data-auction-id="${auction.id}"]`);
            if (auctionCard) {
                // Update the price
                const priceElement = auctionCard.querySelector('.auction-price');
                if (priceElement) {
                    priceElement.textContent = `${auction.current_price} –ª–≤.`;
                }
                
                // Update auction status and timer
                const timeElement = auctionCard.querySelector('.auction-time-remaining');
                const badgeElement = auctionCard.querySelector('.auction-badge');
                
                if (auction.actual_status === 'ended') {
                    if (timeElement) {
                        timeElement.textContent = '–ü—Ä–∏–∫–ª—é—á–∏–ª';
                    }
                    if (badgeElement) {
                        badgeElement.textContent = '–ü—Ä–∏–∫–ª—é—á–∏–ª';
                        badgeElement.classList.add('ended');
                    }
                    // Remove bidding section if auction ended
                    const biddingSection = auctionCard.querySelector('.bidding-section');
                    if (biddingSection) {
                        biddingSection.remove();
                    }
                } else {
                    // Update timer for active auctions
                    if (timeElement) {
                        timeElement.textContent = formatTimeRemaining(auction.time_remaining);
                    }
                }
                
                // Update bid input minimum value for active auctions
                const bidInput = auctionCard.querySelector('.bid-input');
                if (bidInput && auction.actual_status === 'active') {
                    bidInput.min = parseFloat(auction.current_price) + 1;
                }
                
                // Update top bidders display
                if (auction.top_bidders) {
                    const topBiddersElement = auctionCard.querySelector('.top-bidders');
                    if (topBiddersElement) {
                        const isEnded = auction.actual_status === 'ended';
                        const headerText = isEnded ? '–ö—É–ø–µ–Ω–æ –æ—Ç:' : '–¢–µ–∫—É—â –ø–æ–±–µ–¥–∏—Ç–µ–ª:';
                        const biddersHTML = auction.top_bidders.length > 0 ? 
                            `<div class="bidders-list">
                                <div class="bidders-header">${headerText}</div>
                                <div class="bidder-item winner">üèÜ ${auction.top_bidders[0].username}: ${auction.top_bidders[0].bid_amount} –ª–≤.</div>
                            </div>` :
                            `<span><i class="fas fa-gavel"></i> –ù—è–º–∞ –Ω–∞–¥–¥–∞–≤–∞–Ω–∏—è</span>`;
                        
                        topBiddersElement.innerHTML = biddersHTML;
                    }
                }
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('bg-BG');
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substr(0, maxLength).trim() + '...';
        }

        function showAuctionDetails(auctionId) {
            const auction = currentAuctions.find(a => a.id === auctionId);
            if (!auction) return;

            const timeLeft = formatTimeRemaining(auction.time_remaining);
            const isActive = auction.actual_status === 'active';
            const currentPrice = auction.current_price || auction.starting_price;

            // If auction has ended, show results instead of bidding interface
            if (!isActive) {
                showAuctionResults(auctionId);
                return;
            }

            const modalHTML = `
                <div class="modal-overlay" id="auctionModal" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2 class="modal-title">${auction.title}</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="modal-image">
                                ${auction.image_url ? 
                                    `<img src="${auction.image_url}" alt="${auction.title}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` : 
                                    '<i class="fas fa-image" style="font-size: 3rem; color: #ccc;"></i>'
                                }
                            </div>
                            ${auction.top_bidders && auction.top_bidders.length > 0 ? `
                                <div class="modal-bidders-container">
                                    <div class="modal-bidders-title">
                                        <i class="fas fa-trophy"></i> –¢–æ–ø –Ω–∞–¥–¥–∞–≤–∞—â–∏
                                    </div>
                                    <div class="modal-bidders-list">
                                        ${auction.top_bidders.map((bidder, index) => 
                                            `<div class="modal-bidder-item ${index === 0 ? 'winner' : ''}">
                                                ${index === 0 ? '<i class="fas fa-crown" style="color: #ffc107; margin-right: 5px;"></i>' : ''}
                                                <strong>${bidder.username}</strong>: ${bidder.bid_amount} –ª–≤.
                                            </div>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="modal-price">${currentPrice} –ª–≤.</div>
                            <div class="modal-description">${auction.description || '–ù—è–º–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —Ç–æ–∑–∏ —Ç—ä—Ä–≥.'}</div>
                            <div class="modal-meta">
                                <div class="modal-meta-item">
                                    <span class="modal-meta-label">–°—Ç–∞—Ç—É—Å:</span> 
                                    <span style="color: ${isActive ? '#28a745' : '#dc3545'}">${isActive ? '–ê–∫—Ç–∏–≤–µ–Ω —Ç—ä—Ä–≥' : '–ü—Ä–∏–∫–ª—é—á–∏–ª —Ç—ä—Ä–≥'}</span>
                                </div>
                                <div class="modal-meta-item">
                                    <span class="modal-meta-label">–û—Å—Ç–∞–≤–∞—â–æ –≤—Ä–µ–º–µ:</span> <span class="modal-time-remaining" data-auction-id="${auction.id}">${timeLeft}</span>
                                </div>
                                <div class="modal-meta-item">
                                    <span class="modal-meta-label">–ù–∞—á–∞–ª–Ω–∞ —Ü–µ–Ω–∞:</span> ${auction.starting_price} –ª–≤.
                                </div>
                                <div class="modal-meta-item">
                                    <span class="modal-meta-label">–ë—Ä–æ–π –Ω–∞–¥–¥–∞–≤–∞–Ω–∏—è:</span> ${auction.total_bids || 0}
                                </div>
                                <div class="modal-meta-item">
                                    <span class="modal-meta-label">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</span> ${auction.location || '–ù–µ –µ –ø–æ—Å–æ—á–µ–Ω–æ'}
                                </div>
                                <div class="modal-meta-item">
                                    <span class="modal-meta-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span> ${getCategoryName(auction.category)}
                                </div>
                                <div class="modal-meta-item">
                                    <span class="modal-meta-label">–ü—Ä–æ–¥–∞–≤–∞—á:</span> <a href="#" onclick="showUserProfile('${auction.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}'); return false;" style="color: #11998e; text-decoration: none;">${auction.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</a>
                                </div>
                                ${auction.buy_now_price ? `
                                    <div class="modal-meta-item">
                                        <span class="modal-meta-label">–¶–µ–Ω–∞ "–ö—É–ø–∏ —Å–µ–≥–∞":</span> ${auction.buy_now_price} –ª–≤.
                                    </div>
                                ` : ''}
                            </div>
                            ${isActive ? `
                                <div class="modal-actions">
                                    <div class="bid-form" style="margin-bottom: 10px;">
                                        <input type="number" class="bid-input" id="modalBidInput" placeholder="–í—ä–≤–µ–¥–µ—Ç–µ —Å—É–º–∞..." min="${parseFloat(currentPrice) + 1}" max="99999999.99" step="0.01">
                                        <button class="bid-btn" onclick="placeBidFromModal(${auction.id})">–ù–∞–¥–¥–∞–π</button>
                                    </div>
                                    ${auction.buy_now_price ? `<button class="buy-now-btn" onclick="buyNow(${auction.id}, ${auction.buy_now_price})">–ö—É–ø–∏ —Å–µ–≥–∞ –∑–∞ ${auction.buy_now_price} –ª–≤.</button>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('auctionModal').style.display = 'flex';
        }

        async function showAuctionResults(auctionId) {
            try {
                const response = await fetch(`/backend/auction_results.php?auction_id=${auctionId}`);
                const data = await response.json();
                
                if (!data.success) {
                    showToast('–ì—Ä–µ—à–∫–∞', data.message, 'error');
                    return;
                }
                
                const auction = data.auction;
                const winner = data.winner;
                const bids = data.bids;
                
                const modalHTML = `
                    <div class="modal-overlay" id="auctionModal" onclick="closeModal(event)">
                        <div class="modal" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h2 class="modal-title">üèÜ –†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç —Ç—ä—Ä–≥–∞</h2>
                                <button class="modal-close" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="modal-image">
                                    ${auction.image_url ? 
                                        `<img src="${auction.image_url}" alt="${auction.title}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` : 
                                        '<i class="fas fa-image" style="font-size: 3rem; color: #ccc;"></i>'
                                    }
                                </div>
                                <h3>${auction.title}</h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    ${winner ? `
                                        <div style="color: #28a745; font-weight: bold; margin-bottom: 10px;">
                                            <i class="fas fa-trophy"></i> –ü–æ–±–µ–¥–∏—Ç–µ–ª: ${winner.username}
                                        </div>
                                        <div style="font-size: 1.2rem; color: #11998e;">
                                            <strong>–ü–µ—á–µ–ª–∏–≤—à–∞ —Ü–µ–Ω–∞: ${winner.winning_bid} –ª–≤.</strong>
                                        </div>
                                    ` : `
                                        <div style="color: #666;">
                                            <i class="fas fa-info-circle"></i> –ù—è–º–∞ –Ω–∞–¥–¥–∞–≤–∞–Ω–∏—è –∑–∞ —Ç–æ–∑–∏ —Ç—ä—Ä–≥
                                        </div>
                                        <div style="color: #999;">
                                            –ù–∞—á–∞–ª–Ω–∞ —Ü–µ–Ω–∞: ${auction.starting_price} –ª–≤.
                                        </div>
                                    `}
                                </div>
                                
                                <div class="modal-meta">
                                    <div class="modal-meta-item">
                                        <span class="modal-meta-label">–°—Ç–∞—Ç—É—Å:</span> 
                                        <span style="color: #dc3545">–ü—Ä–∏–∫–ª—é—á–∏–ª —Ç—ä—Ä–≥</span>
                                    </div>
                                    <div class="modal-meta-item">
                                        <span class="modal-meta-label">–ü—Ä–∏–∫–ª—é—á–µ–Ω –Ω–∞:</span> ${formatDate(auction.end_time)}
                                    </div>
                                    <div class="modal-meta-item">
                                        <span class="modal-meta-label">–ù–∞—á–∞–ª–Ω–∞ —Ü–µ–Ω–∞:</span> ${auction.starting_price} –ª–≤.
                                    </div>
                                    <div class="modal-meta-item">
                                        <span class="modal-meta-label">–û–±—â–æ –Ω–∞–¥–¥–∞–≤–∞–Ω–∏—è:</span> ${auction.total_bids}
                                    </div>
                                    <div class="modal-meta-item">
                                        <span class="modal-meta-label">–ü—Ä–æ–¥–∞–≤–∞—á:</span> <a href="#" onclick="showUserProfile('${auction.seller_username}'); return false;" style="color: #11998e; text-decoration: none;">${auction.seller_username}</a>
                                    </div>
                                </div>
                                
                                ${auction.description ? `
                                    <div style="margin: 15px 0;">
                                        <h4>–û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                                        <p style="color: #666; line-height: 1.5;">${auction.description}</p>
                                    </div>
                                ` : ''}
                                
                                ${bids.length > 0 ? `
                                    <div style="margin-top: 20px;">
                                        <h4>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –Ω–∞–¥–¥–∞–≤–∞–Ω–∏—è—Ç–∞:</h4>
                                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; padding: 10px;">
                                            ${bids.map(bid => `
                                                <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f5f5f5; ${bid.is_winning ? 'background: #e8f5e8; font-weight: bold;' : ''}">
                                                    <span>${bid.username} ${bid.is_winning ? 'üèÜ' : ''}</span>
                                                    <span>${bid.bid_amount} –ª–≤.</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.getElementById('auctionModal').style.display = 'flex';
                
            } catch (error) {
                showToast('–ì—Ä–µ—à–∫–∞', '–ù–µ –º–æ–∂–∞—Ö–º–µ –¥–∞ –∑–∞—Ä–µ–¥–∏–º —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ—Ç —Ç—ä—Ä–≥–∞.', 'error');
            }
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('auctionModal') || document.getElementById('userModal');
            if (modal) {
                modal.style.display = 'none';
                setTimeout(() => modal.remove(), 300);
            }
        }

        function showUserProfile(username) {
            const modalHTML = `
                <div class="modal-overlay" id="userModal" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2 class="modal-title">üë§ ${username}</h2>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('userModal').style.display = 'flex';
        }

        async function showMyProfile() {
            if (!currentUser) {
                alert('–ú–æ–ª—è, –≤–ª–µ–∑—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏ –ø—ä—Ä–≤–æ');
                return;
            }
            
            try {
                const response = await fetch('/backend/user_profile.php');
                const data = await response.json();
                
                if (!data.success) {
                    alert('–ì—Ä–µ—à–∫–∞: ' + data.message);
                    return;
                }
                
                let html = `
                    <div class="modal-overlay" id="userModal" onclick="closeModal(event)">
                        <div class="modal" onclick="event.stopPropagation()" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h2 class="modal-title">üë§ ${data.user.username}</h2>
                                <button class="modal-close" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="background: linear-gradient(135deg, #11998e, #38d9a9); color: white; padding: 20px; border-radius: 10px; margin-bottom: 25px; text-align: center;">
                                    <h3 style="margin: 0; color: white;">${data.user.full_name || data.user.username}</h3>
                                    <p style="margin: 5px 0; opacity: 0.9;">üìß ${data.user.email || '–ù–µ –µ –ø–æ—Å–æ—á–µ–Ω –∏–º–µ–π–ª'}</p>
                                    <p style="margin: 5px 0; opacity: 0.9;">üìÖ –ß–ª–µ–Ω –æ—Ç: ${formatDate(data.user.created_at)}</p>
                                </div>
                                
                                <!-- Statistics Overview -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                                    <div style="background: white; border: 2px solid #11998e; border-radius: 10px; padding: 15px; text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold; color: #11998e;">${data.stats.auctions_created}</div>
                                        <div style="color: #666; font-size: 0.9rem;">–°—ä–∑–¥–∞–¥–µ–Ω–∏ —Ç—ä—Ä–≥–æ–≤–µ</div>
                                    </div>
                                    <div style="background: white; border: 2px solid #17a2b8; border-radius: 10px; padding: 15px; text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold; color: #17a2b8;">${data.stats.total_bids_placed}</div>
                                        <div style="color: #666; font-size: 0.9rem;">–û–±—â–æ –Ω–∞–¥–¥–∞–≤–∞–Ω–∏—è</div>
                                    </div>
                                    <div style="background: white; border: 2px solid #28a745; border-radius: 10px; padding: 15px; text-align: center;">
                                        <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${data.stats.auctions_won}</div>
                                        <div style="color: #666; font-size: 0.9rem;">–°–ø–µ—á–µ–ª–µ–Ω–∏ —Ç—ä—Ä–≥–æ–≤–µ</div>
                                    </div>
                                </div>
                                
                                <!-- Additional Stats -->
                                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 25px;">
                                    <h4 style="margin: 0 0 10px 0; color: #495057;">üìä –î–µ—Ç–∞–π–ª–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>üìà –£—á–∞—Å—Ç–∏—è –≤ —Ç—ä—Ä–≥–æ–≤–µ:</span>
                                            <strong>${data.stats.auctions_participated}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>üí∞ –°—Ä–µ–¥–Ω–æ –Ω–∞–¥–¥–∞–≤–∞–Ω–µ:</span>
                                            <strong>${parseFloat(data.stats.avg_bid_amount).toFixed(2)} –ª–≤.</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>üè™ –°—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ —Ç—ä—Ä–≥–æ–≤–µ:</span>
                                            <strong>${parseFloat(data.stats.total_auction_value).toFixed(2)} –ª–≤.</strong>
                                        </div>
                                    </div>
                                </div>
                
                                <!-- Recent Activity -->
                                <div style="margin-bottom: 25px;">
                                    <h4 style="color: #11998e; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; margin-bottom: 15px;">
                                        üïê –ü–æ—Å–ª–µ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç
                                    </h4>
                `;
                
                if (data.recentBids.length > 0) {
                    html += '<div>';
                    data.recentBids.forEach(bid => {
                        const isWinning = bid.is_winning;
                        const bgColor = isWinning ? '#e8f5e8' : '#fff';
                        const borderColor = isWinning ? '#28a745' : '#e9ecef';
                        html += `
                            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${bid.title}</strong> ${isWinning ? 'üëë' : ''}<br>
                                        <small style="color: #666;">${formatDate(bid.bid_time)} ‚Ä¢ ${bid.status === 'active' ? 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω' : 'üî¥ –ü—Ä–∏–∫–ª—é—á–∏–ª'}</small>
                                    </div>
                                    <div style="font-weight: bold; color: ${isWinning ? '#28a745' : '#11998e'};">${bid.bid_amount} –ª–≤.</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px;">–ù—è–º–∞ —Å–∫–æ—Ä–æ—à–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç</div>';
                }
                
                html += `
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <h4 style="color: #11998e; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; margin-bottom: 15px;">
                                        üè™ –°—ä–∑–¥–∞–¥–µ–Ω–∏ —Ç—ä—Ä–≥–æ–≤–µ (${data.created.length})
                                    </h4>
                `;
                
                if (data.created.length > 0) {
                    html += '<div>';
                    data.created.forEach(auction => {
                        const statusColor = auction.status === 'active' ? '#28a745' : '#6c757d';
                        const statusText = auction.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ü—Ä–∏–∫–ª—é—á–∏–ª';
                        const currentPrice = auction.current_price || auction.starting_price;
                        html += `
                            <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #333;">${auction.title}</strong><br>
                                        <small style="color: #666;">–°—ä–∑–¥–∞–¥–µ–Ω: ${formatDate(auction.created_at)} ‚Ä¢ ${auction.bid_count} –Ω–∞–¥–¥–∞–≤–∞–Ω–∏—è</small>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: #11998e;">${currentPrice} –ª–≤.</div>
                                        <small style="color: #666;">–æ—Ç ${auction.starting_price} –ª–≤.</small><br>
                                        <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">${statusText}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px;">–ù—è–º–∞ —Å—ä–∑–¥–∞–¥–µ–Ω–∏ —Ç—ä—Ä–≥–æ–≤–µ</div>';
                }
                
                html += `
                                </div>
                                
                                <div>
                                    <h4 style="color: #11998e; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; margin-bottom: 15px;">
                                        üèÜ –°–ø–µ—á–µ–ª–µ–Ω–∏ —Ç—ä—Ä–≥–æ–≤–µ (${data.won.length})
                                    </h4>
                `;
                
                if (data.won.length > 0) {
                    html += '<div>';
                    data.won.forEach(auction => {
                        html += `
                            <div style="background: linear-gradient(135deg, #f8fff8, #e8f5e8); border: 1px solid #d4edda; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #333;">${auction.title} üèÜ</strong><br>
                                        <small style="color: #666;">–°–ø–µ—á–µ–ª–µ–Ω: ${formatDate(auction.end_time)} ‚Ä¢ —Å—Ä–µ—â—É ${auction.total_bidders} —É—á–∞—Å—Ç–Ω–∏—Ü–∏</small>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: #28a745; font-size: 1.2rem;">${auction.bid_amount} –ª–≤.</div>
                                        <small style="color: #28a745;">üí∞ –ü–µ—á–µ–ª–∏–≤—à–∞ —Ü–µ–Ω–∞</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<div style="text-align: center; color: #666; padding: 20px; background: #f8f9fa; border-radius: 8px;">–ù—è–º–∞ —Å–ø–µ—á–µ–ª–µ–Ω–∏ —Ç—ä—Ä–≥–æ–≤–µ</div>';
                }
                
                html += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
                document.getElementById('userModal').style.display = 'flex';
                
            } catch (error) {
                alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ—Ç–æ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞');
            }
        }

        function placeBidFromModal(auctionId) {
            // Check if user is logged in
            if (!currentUser) {
                showToast('–ù–µ–æ–±—Ö–æ–¥–∏–º –≤—Ö–æ–¥', '–¢—Ä—è–±–≤–∞ –¥–∞ —Å—Ç–µ –≤–ª–µ–∑–ª–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏, –∑–∞ –¥–∞ –Ω–∞–¥–¥–∞–≤–∞—Ç–µ!', 'warning');
                return;
            }
            
            const bidInput = document.getElementById('modalBidInput');
            const bidAmount = parseFloat(bidInput.value);
            
            if (!bidAmount) { 
                showToast('–ù–µ–≤–∞–ª–∏–¥–Ω–∞ —Å—É–º–∞', '–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–Ω–∞ —Å—É–º–∞ –∑–∞ –Ω–∞–¥–¥–∞–≤–∞–Ω–µ!', 'warning');
                return; 
            }
            
            // Validate maximum bid amount
            if (bidAmount > 99999999.99) {
                showToast('–¢–≤—ä—Ä–¥–µ –≥–æ–ª—è–º–∞ —Å—É–º–∞', '–ú–∞–∫—Å–∏–º–∞–ª–Ω–∞—Ç–∞ –≤—ä–∑–º–æ–∂–Ω–∞ –Ω–∞–¥–¥–∞–≤–∫–∞ –µ 99,999,999.99 –ª–≤.!', 'warning');
                return;
            }
            
            // Use the same placeBid logic but close modal on success
            fetch('/backend/auctions.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auction_id: auctionId, bid_amount: bidAmount })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    
                    // Update the auction data in memory and UI immediately
                    updateAuctionAfterBid(auctionId, data.new_price, data.total_bids, data.top_bidders);
                    
                } else {
                    showToast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –Ω–∞–¥–¥–∞–≤–∞–Ω–µ', data.message || '–í—ä–∑–Ω–∏–∫–Ω–∞ –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ –Ω–∞–¥–¥–∞–≤–∞–Ω–µ—Ç–æ.', 'error');
                }
            })
            .catch(error => {
                showToast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ', '–ù–µ –º–æ–∂–∞—Ö–º–µ –¥–∞ —Å–µ —Å–≤—ä—Ä–∂–µ–º —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.', 'error');
            });
        }

        function getCategoryName(category) {
            const categories = {
                'electronics': '–ï–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞',
                'fashion': '–ú–æ–¥–∞',
                'home': '–î–æ–º –∏ –≥—Ä–∞–¥–∏–Ω–∞',
                'sports': '–°–ø–æ—Ä—Ç',
                'cars': '–ê–≤—Ç–æ–º–æ–±–∏–ª–∏',
                'others': '–î—Ä—É–≥–∏'
            };
            return categories[category] || '–î—Ä—É–≥–∏';
        }

        async function deleteAuction(auctionId) {
            if (!confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–∑–∏ —Ç—ä—Ä–≥? –¢–æ–≤–∞ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.')) {
                return;
            }

            try {
                const response = await fetch('/backend/delete_auction.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ auction_id: auctionId })
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast('–£—Å–ø–µ—Ö!', data.message, 'success');
                    // Remove the auction from the current list and re-render
                    currentAuctions = currentAuctions.filter(auction => auction.id != auctionId);
                    renderAuctions();
                } else {
                    showToast('–ì—Ä–µ—à–∫–∞', data.message, 'error');
                }
            } catch (error) {
                showToast('–ì—Ä–µ—à–∫–∞', '–í—ä–∑–Ω–∏–∫–Ω–∞ –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ—Ç–æ –Ω–∞ —Ç—ä—Ä–≥–∞. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.', 'error');
            }
        }

        // Login/Logout
        document.getElementById('loginLink').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = '/frontend/pages/login.html';
        });

        document.getElementById('logoutLink').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await fetch('/backend/logout.php');
                window.location.reload();
            } catch (error) { console.error('Logout error:', error); }
        });
    </script>
</body>
</html>
